<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!--Description-->



    <meta name="description" content="前端同学们对于axios应该都有所耳闻。但你有没有好奇过，axios是如何实现的呢？源码又是怎样的呢？
让我们一起花十分钟的时间，深入学习 axios 的源码实现！

axios 实例与请求流程在深入源码之前，先简要了解一下axios实例的属性和整体请求流程，这将有助于我们更轻松地阅读源码。下面是a"/>


<!--Author-->

    <meta name="author" content="John Doe"/>


<!--Open Graph Title-->

    <meta property="og:title" content="来，花点时间带你深入了解axios源码实现"/>


<!--Open Graph Description-->

    <meta property="og:description" content="前端同学们对于axios应该都有所耳闻。但你有没有好奇过，axios是如何实现的呢？源码又是怎样的呢？
让我们一起花十分钟的时间，深入学习 axios 的源码实现！

axios 实例与请求流程在深入源码之前，先简要了解一下axios实例的属性和整体请求流程，这将有助于我们更轻松地阅读源码。下面是a"/>


<!--Open Graph Site Name-->
    <meta property="og:site_name" content="&lt;img src=&#34;/images/liu.jpg&#34; style=&#34;width:100px; height:100px; object-fit:cover; border-radius:50%; object-position:top;&#34; /&gt;"/>

<!--Type page-->

    <meta property="og:type" content="article"/>


<!--Page Cover-->


    <meta property="og:image" content="http://example.com/img/home-bg.jpg"/>


<meta name="twitter:card" content="summary_large_image"/>




    <meta name="twitter:image" content="http://example.com/img/home-bg.jpg"/>


<!-- Title -->

<title>刘金根个人博客</title>

<!-- Bootstrap Core CSS -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">

<!-- Custom CSS -->

<link rel="stylesheet" href="/css/main.css">


<!-- Custom Fonts -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.0/css/all.min.css" />
<link href="//fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Gallery -->
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/featherlight@1.4.0/src/featherlight.css" integrity="sha256-30DV/STftlyQ6v8yaOWlabammvCYtRJERLj/m0b3zno=" crossorigin="anonymous">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/css/lightgallery.min.css">

<!-- favicon -->

<link rel="icon" href="/img/favicon.png"/>



    <!-- Google Analytics -->
    


<meta name="generator" content="Hexo 6.3.0"></head>
<!-- Head tag -->

<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top bg-transparent position-absolute w-100 p-0" id="nav">
    <div class="container pl-0 pr-0">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <a class="navbar-brand text-white p-1 pl-3" href="/">刘金根</a>
        </div>
        <div class="navbar-nav float-right">
            <button class="btn btn-link search-btn navbar-item" data-toggle="modal" data-target="#searchModal">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 col-md-12 text-center">
                <div class="post-heading text-white">
                    <h1>来，花点时间带你深入了解axios源码实现</h1>
                    
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Main Content -->
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
                
                    <span class="meta d-inline-block">
    
    
    <!-- Date -->
    
        <span class="post-meta-split">&nbsp;|&nbsp;</span>
        <i class="far fa-calendar-check fa-fw"></i>
        2024-01-22
    
    <!-- word count and read count -->
    

    

    
</span>  
                
                <p>前端同学们对于axios应该都有所耳闻。但你有没有好奇过，axios是如何实现的呢？源码又是怎样的呢？</p>
<p>让我们一起花十分钟的时间，深入学习 <strong>axios 的源码实现！</strong></p>
<p><img src="https://mmbiz.qpic.cn/sz_mmbiz_png/Ptef09iaEWxzsDMTHp46ZcPCWNwJdymDjiblAr8sK5YuChNZibibT2GGF1Sudw9yZmiaHldUP9tJ7op7L76Lfqebv9A/640?wx_fmt=png&from=appmsg&wxfrom=13"></p>
<h4 id="axios-实例与请求流程"><a href="#axios-实例与请求流程" class="headerlink" title="axios 实例与请求流程"></a><center><font color="green">axios 实例与请求流程</font></center></h4><p>在深入源码之前，先简要了解一下axios实例的属性和整体请求流程，这将有助于我们更轻松地阅读源码。<br>下面是axios实例属性的简图：<br><img src="https://mmbiz.qpic.cn/sz_mmbiz_png/Ptef09iaEWxzsDMTHp46ZcPCWNwJdymDjibeAZwu21iaPOicstK3CdrTj3yGMqbvqhGrEKUSFdATdibcMo8n3aGd45Q/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1"><br>axios 实例主要有三个核心属性：</p>
<ul>
<li><p>config：包括url、method、params、headers等配置。</p>
</li>
<li><p>interceptors ：拦截器，分为请求拦截器和返回拦截器。</p>
</li>
<li><p>request：用于调用xhr或http请求的方法，参数是config。</p>
</li>
</ul>
<p>由于可以再次传入config调用request方法，但不能传入interceptors，因此需要在axios上提前添加拦截器，无法临时添加。</p>
<p>以下是axios的请求流程图<br><img src="https://mmbiz.qpic.cn/sz_mmbiz_png/Ptef09iaEWxzsDMTHp46ZcPCWNwJdymDj1KbCQRykZBxDYzDoseZwlWk3Nzr0Xq99XJAmMAGA6hI5CxfGLsicAKg/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1"></p>
<h4 id="源码文件结构解析"><a href="#源码文件结构解析" class="headerlink" title="源码文件结构解析"></a><center><font color="green">源码文件结构解析</font></center></h4><p>axios的源码都在lib文件夹下，最核心的内容在core文件夹里。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">lib</span><br><span class="line">│  axios.<span class="property">js</span>    <span class="comment">// 最终导出的文件</span></span><br><span class="line">│  utils.<span class="property">js</span>    <span class="comment">// 工具类</span></span><br><span class="line">├─adapters     <span class="comment">// 适配器相关</span></span><br><span class="line">│      adapters.<span class="property">js</span> <span class="comment">//适配器类</span></span><br><span class="line">│      http.<span class="property">js</span>     <span class="comment">// node请求</span></span><br><span class="line">│      xhr.<span class="property">js</span>      <span class="comment">// 浏览器请求</span></span><br><span class="line">├─cancel      <span class="comment">// 取消功能相关</span></span><br><span class="line">│      <span class="title class_">CanceledError</span>.<span class="property">js</span> <span class="comment">//取消异常类</span></span><br><span class="line">│      <span class="title class_">CancelToken</span>.<span class="property">js</span>   <span class="comment">//取消token类</span></span><br><span class="line">│      isCancel.<span class="property">js</span>      <span class="comment">//判断是否取消</span></span><br><span class="line">├─core       <span class="comment">// 核心功能相关 </span></span><br><span class="line">│      <span class="title class_">Axios</span>.<span class="property">js</span>                 <span class="comment">// axios类</span></span><br><span class="line">│      <span class="title class_">AxiosError</span>.<span class="property">js</span>            <span class="comment">// axios异常类</span></span><br><span class="line">│      <span class="title class_">AxiosHeaders</span>.<span class="property">js</span>          <span class="comment">// 请求头</span></span><br><span class="line">│      buildFullPath.<span class="property">js</span>         <span class="comment">// 构造请求地址</span></span><br><span class="line">│      dispatchRequest.<span class="property">js</span>       <span class="comment">// 发送请求方法</span></span><br><span class="line">│      <span class="title class_">InterceptorManager</span>.<span class="property">js</span>    <span class="comment">// 拦截器的类</span></span><br><span class="line">│      mergeConfig.<span class="property">js</span>           <span class="comment">// 合并配置方法</span></span><br><span class="line">│      settle.<span class="property">js</span>                <span class="comment">// 处理请求结果方法</span></span><br><span class="line">│      transformData.<span class="property">js</span>         <span class="comment">// 数据转换执行方法</span></span><br><span class="line">├─defaults    <span class="comment">// 默认配置</span></span><br><span class="line">│      index.<span class="property">js</span>                 <span class="comment">// 默认请求参数配置</span></span><br><span class="line">│      transitional.<span class="property">js</span>          <span class="comment">// 默认transitional配置</span></span><br><span class="line">├─env        <span class="comment">//  node环境没有FormData，</span></span><br><span class="line">│  │  data.<span class="property">js</span></span><br><span class="line">│  └─classes</span><br><span class="line">│          <span class="title class_">FormData</span>.<span class="property">js</span></span><br><span class="line">├─helpers  <span class="comment">// 各种工具类方法，看名字就可以大概猜到作用（太长了进行省略...）</span></span><br><span class="line">│      ...</span><br><span class="line">└─platform  <span class="comment">// 为不同环境下准备的方法（太长了进行省略...）</span></span><br><span class="line">       ...</span><br></pre></td></tr></table></figure>
<h4 id="源码文件阅读"><a href="#源码文件阅读" class="headerlink" title="源码文件阅读"></a><center><font color="green">源码文件阅读</font></center></h4><h4 id="入口文件-axios-js"><a href="#入口文件-axios-js" class="headerlink" title="入口文件 axios.js"></a>入口文件 axios.js</h4><p>该文件创建了axios实例并导出，因此我们通过<code>import axios from &#39;axios&#39;</code></td>引入的即为该实例，无需再new Axios({…})。</p>
<p>以下是axios实例创建的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心方法，根据config创建axios实例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createInstance</span> (defaultConfig) &#123;</span><br><span class="line">  <span class="comment">// 创建axios实例</span></span><br><span class="line">  <span class="keyword">const</span> context = <span class="keyword">new</span> <span class="title class_">Axios</span>(defaultConfig);</span><br><span class="line">  <span class="comment">// 给Axios原型上的request方法绑定context为它的this</span></span><br><span class="line">  <span class="comment">// 这个instance就是我们最终使用的axios</span></span><br><span class="line">  <span class="comment">// 没想到吧，最开始的instance其实是个函数，</span></span><br><span class="line">  <span class="comment">// 所以我们才可以使用这个用法axios(&#x27;/api/url&#x27;)</span></span><br><span class="line">  <span class="comment">// 只不过后面给它扩展了很多东西</span></span><br><span class="line">  <span class="keyword">const</span> instance = <span class="title function_">bind</span>(<span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">request</span>, context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将Axios.prototype上的属性都绑定到instance上，</span></span><br><span class="line">  <span class="comment">// 这样它就拥有了简写的请求方法，比如axios.get(),axios.post()</span></span><br><span class="line">  <span class="comment">// 如果是函数，this绑定为context</span></span><br><span class="line">  utils.<span class="title function_">extend</span>(instance, <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>, context, &#123; <span class="attr">allOwnKeys</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将context上的属性都绑定到instance上，</span></span><br><span class="line">  <span class="comment">// 这样它就拥有了拦截器属性，可以使用axios.interceptors.request.use()</span></span><br><span class="line">  <span class="comment">// 因为context上的函数的this本就指向context，所以第三个参数不需要再指定</span></span><br><span class="line">  utils.<span class="title function_">extend</span>(instance, context, <span class="literal">null</span>, &#123; <span class="attr">allOwnKeys</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 给instance增加create方法，可以通过create创建一个实例</span></span><br><span class="line">  instance.<span class="property">create</span> = <span class="keyword">function</span> <span class="title function_">create</span> (instanceConfig) &#123;</span><br><span class="line">    <span class="comment">// 入参为拼接配置项，以instanceConfig为优先</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createInstance</span>(<span class="title function_">mergeConfig</span>(defaultConfig, instanceConfig));</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用上面的方法，最终导出的是axios，</span></span><br><span class="line"><span class="comment">// 其实是Axios.prototype.request，并扩展了很多属性</span></span><br><span class="line"><span class="keyword">const</span> axios = <span class="title function_">createInstance</span>(defaults);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继续给axios增加属性</span></span><br><span class="line"><span class="comment">// 这就说明如果自己通过const myAxios=axios.create(&#123;&#125;);</span></span><br><span class="line"><span class="comment">// 创建出来的实例就没有下面这些属性了</span></span><br><span class="line"><span class="comment">// 所以下面这些属性只能通过import axios from &#x27;axios&#x27;;</span></span><br><span class="line"><span class="comment">// axios.all()这样的方式来使用</span></span><br><span class="line"></span><br><span class="line">axios.<span class="property">Axios</span> = <span class="title class_">Axios</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cancel相关</span></span><br><span class="line">axios.<span class="property">CanceledError</span> = <span class="title class_">CanceledError</span>;</span><br><span class="line">axios.<span class="property">CancelToken</span> = <span class="title class_">CancelToken</span>;</span><br><span class="line">axios.<span class="property">isCancel</span> = isCancel;</span><br><span class="line">axios.<span class="property">VERSION</span> = <span class="variable constant_">VERSION</span>;</span><br><span class="line"><span class="comment">// 工具函数，将对象转为FormData</span></span><br><span class="line">axios.<span class="property">toFormData</span> = toFormData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Axios通用异常类</span></span><br><span class="line">axios.<span class="property">AxiosError</span> = <span class="title class_">AxiosError</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cancel异常类</span></span><br><span class="line">axios.<span class="property">Cancel</span> = axios.<span class="property">CanceledError</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Expose all/spread</span></span><br><span class="line"><span class="comment">// 工具函数</span></span><br><span class="line">axios.<span class="property">all</span> = <span class="keyword">function</span> <span class="title function_">all</span> (promises) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具函数,利用apply将数组参数改为单个传入的参数</span></span><br><span class="line">axios.<span class="property">spread</span> = spread;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断异常是否是AxiosError</span></span><br><span class="line">axios.<span class="property">isAxiosError</span> = isAxiosError;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并config对象方法</span></span><br><span class="line">axios.<span class="property">mergeConfig</span> = mergeConfig;</span><br><span class="line"></span><br><span class="line">axios.<span class="property">AxiosHeaders</span> = <span class="title class_">AxiosHeaders</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具方法</span></span><br><span class="line">axios.<span class="property">formToJSON</span> = <span class="function"><span class="params">thing</span> =&gt;</span> <span class="title function_">formDataToJSON</span>(utils.<span class="title function_">isHTMLForm</span>(thing) ? <span class="keyword">new</span> <span class="title class_">FormData</span>(thing) : thing);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取适配器：xhr 、http</span></span><br><span class="line">axios.<span class="property">getAdapter</span> = adapters.<span class="property">getAdapter</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求状态</span></span><br><span class="line">axios.<span class="property">HttpStatusCode</span> = <span class="title class_">HttpStatusCode</span>;</span><br><span class="line"></span><br><span class="line">axios.<span class="property">default</span> = axios;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最终导出</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> axios</span><br></pre></td></tr></table></figure>
<h4 id="Axios类"><a href="#Axios类" class="headerlink" title="Axios类"></a>Axios类</h4><p>Axios类是 Axios 的核心方法，其中的request方法是最核心的请求方法。</p>
<p>以下是Axios类的核心代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Axios</span> &#123;</span><br><span class="line">  <span class="comment">// 可以看到Axios的构造函数相当简单</span></span><br><span class="line">  <span class="comment">// 仅仅是保存了我们传入的config,</span></span><br><span class="line">  <span class="comment">// 然后初始化空的拦截器对象</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">instanceConfig</span>) &#123;</span><br><span class="line">    <span class="comment">// 所有的配置都设置再defaults上</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">defaults</span> = instanceConfig;</span><br><span class="line">    <span class="comment">// 初始化空的拦截器对象，包含请求拦截器request和返回拦截器response</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interceptors</span> = &#123;</span><br><span class="line">      <span class="attr">request</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>(),</span><br><span class="line">      <span class="attr">response</span>: <span class="keyword">new</span> <span class="title class_">InterceptorManager</span>()</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// request是Axios的核心方法</span></span><br><span class="line">  <span class="comment">// 所有的核心都在request方法里，</span></span><br><span class="line">  <span class="comment">// request方法接收两种参数，【直接传config对象】或者【传url和config对象】</span></span><br><span class="line">  request (configOrUrl, config) &#123;</span><br><span class="line">    <span class="comment">// 允许axios(&#x27;example/url&#x27;[, config]) 这样使用</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> configOrUrl === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">      config = config || &#123;&#125;;</span><br><span class="line">      config.<span class="property">url</span> = configOrUrl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      config = configOrUrl || &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// request会使用传入的配置merge默认配置</span></span><br><span class="line">    <span class="comment">// 所以即使只传了一个url，也会使用默认的Get方法</span></span><br><span class="line">    config = <span class="title function_">mergeConfig</span>(<span class="variable language_">this</span>.<span class="property">defaults</span>, config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; headers &#125; = config;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 默认get请求</span></span><br><span class="line">    config.<span class="property">method</span> = (config.<span class="property">method</span> || <span class="variable language_">this</span>.<span class="property">defaults</span>.<span class="property">method</span> || <span class="string">&#x27;get&#x27;</span>).<span class="title function_">toLowerCase</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 说明header可以直接设置</span></span><br><span class="line">    <span class="comment">// 也可以在common设置通用header,也可以为每种请求设置特定的header</span></span><br><span class="line">    <span class="keyword">let</span> contextHeaders = headers &amp;&amp; utils.<span class="title function_">merge</span>(</span><br><span class="line">      headers.<span class="property">common</span>,</span><br><span class="line">      headers[config.<span class="property">method</span>]</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    headers &amp;&amp; utils.<span class="title function_">forEach</span>(</span><br><span class="line">      [<span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;head&#x27;</span>, <span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>, <span class="string">&#x27;common&#x27;</span>],</span><br><span class="line">      <span class="function">(<span class="params">method</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> headers[method];</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 优先使用headers下配置，再使用headers.common和headers[get,post]的配置</span></span><br><span class="line">    config.<span class="property">headers</span> = <span class="title class_">AxiosHeaders</span>.<span class="title function_">concat</span>(contextHeaders, headers);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求拦截器链</span></span><br><span class="line">    <span class="keyword">const</span> requestInterceptorChain = [];</span><br><span class="line">    <span class="comment">// 记录是否使用同步的方式调用，我们配置拦截器的时候，默认是false，也就是异步</span></span><br><span class="line">    <span class="keyword">let</span> synchronousRequestInterceptors = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">unshiftRequestInterceptors</span> (interceptor) &#123;</span><br><span class="line">      <span class="comment">// 如果配置了runWhen函数，那么会先执行runWhen，如果为true，才会添加该拦截器</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> interceptor.<span class="property">runWhen</span> === <span class="string">&#x27;function&#x27;</span> &amp;&amp; interceptor.<span class="title function_">runWhen</span>(config) === <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      synchronousRequestInterceptors = synchronousRequestInterceptors &amp;&amp; interceptor.<span class="property">synchronous</span>;</span><br><span class="line">      <span class="comment">// unshift说明后传入的请求拦截器先执行，一次放入两个，分别是fulfilled和rejected</span></span><br><span class="line">      requestInterceptorChain.<span class="title function_">unshift</span>(interceptor.<span class="property">fulfilled</span>, interceptor.<span class="property">rejected</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应拦截器链</span></span><br><span class="line">    <span class="keyword">const</span> responseInterceptorChain = [];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">forEach</span>(<span class="keyword">function</span> <span class="title function_">pushResponseInterceptors</span> (interceptor) &#123;</span><br><span class="line">    <span class="comment">// push说明先传入的响应拦截器先执行</span></span><br><span class="line">      responseInterceptorChain.<span class="title function_">push</span>(interceptor.<span class="property">fulfilled</span>, interceptor.<span class="property">rejected</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> promise;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认是异步执行，也就是一个执行完再执行下一个</span></span><br><span class="line">    <span class="keyword">if</span> (!synchronousRequestInterceptors) &#123;</span><br><span class="line">      <span class="comment">//dispatchRequest是真正的发送请求</span></span><br><span class="line">      <span class="keyword">const</span> chain = [dispatchRequest.<span class="title function_">bind</span>(<span class="variable language_">this</span>), <span class="literal">undefined</span>];</span><br><span class="line">      <span class="comment">// 前面插入请求拦截器</span></span><br><span class="line">      chain.<span class="property">unshift</span>.<span class="title function_">apply</span>(chain, requestInterceptorChain);</span><br><span class="line">      <span class="comment">// 后面插入响应拦截器</span></span><br><span class="line">      chain.<span class="property">push</span>.<span class="title function_">apply</span>(chain, responseInterceptorChain);</span><br><span class="line">      len = chain.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">      promise = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(config);</span><br><span class="line">      <span class="comment">// 依次执行</span></span><br><span class="line">      <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">        promise = promise.<span class="title function_">then</span>(chain[i++], chain[i++]);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> promise;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    len = requestInterceptorChain.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> newConfig = config;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 同步执行，请求拦截器</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">      <span class="keyword">const</span> onFulfilled = requestInterceptorChain[i++];</span><br><span class="line">      <span class="keyword">const</span> onRejected = requestInterceptorChain[i++];</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        newConfig = <span class="title function_">onFulfilled</span>(newConfig);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        onRejected.<span class="title function_">call</span>(<span class="variable language_">this</span>, error);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发起请求</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      promise = dispatchRequest.<span class="title function_">call</span>(<span class="variable language_">this</span>, newConfig);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    len = responseInterceptorChain.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回有异常可以继续走下去</span></span><br><span class="line">    <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">      promise = promise.<span class="title function_">then</span>(responseInterceptorChain[i++], responseInterceptorChain[i++]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取请求地址</span></span><br><span class="line">  getUri (config) &#123;</span><br><span class="line">    config = <span class="title function_">mergeConfig</span>(<span class="variable language_">this</span>.<span class="property">defaults</span>, config);</span><br><span class="line">    <span class="keyword">const</span> fullPath = <span class="title function_">buildFullPath</span>(config.<span class="property">baseURL</span>, config.<span class="property">url</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">buildURL</span>(fullPath, config.<span class="property">params</span>, config.<span class="property">paramsSerializer</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Provide aliases for supported request methods</span></span><br><span class="line"><span class="comment">// 给Axios原型注入四个请求方法，请求方法本质都是调用request方法</span></span><br><span class="line"><span class="comment">// 这四个都是不带请求体的</span></span><br><span class="line">utils.<span class="title function_">forEach</span>([<span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&#x27;head&#x27;</span>, <span class="string">&#x27;options&#x27;</span>], <span class="keyword">function</span> <span class="title function_">forEachMethodNoData</span> (method) &#123;</span><br><span class="line">  <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>[method] = <span class="keyword">function</span> (<span class="params">url, config</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(<span class="title function_">mergeConfig</span>(config || &#123;&#125;, &#123;</span><br><span class="line">      method,</span><br><span class="line">      url,</span><br><span class="line">      <span class="attr">data</span>: (config || &#123;&#125;).<span class="property">data</span></span><br><span class="line">    &#125;));</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给Axios注入post,put,patch,postForm,putForm,patchForm方法</span></span><br><span class="line"><span class="comment">// 这几个方法都是带请求体的</span></span><br><span class="line">utils.<span class="title function_">forEach</span>([<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>], <span class="keyword">function</span> <span class="title function_">forEachMethodWithData</span> (method) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">generateHTTPMethod</span> (isForm) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">httpMethod</span> (url, data, config) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(<span class="title function_">mergeConfig</span>(config || &#123;&#125;, &#123;</span><br><span class="line">        method,</span><br><span class="line">        <span class="attr">headers</span>: isForm ? &#123;</span><br><span class="line">          <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;multipart/form-data&#x27;</span></span><br><span class="line">        &#125; : &#123;&#125;,</span><br><span class="line">        url,</span><br><span class="line">        data</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>[method] = <span class="title function_">generateHTTPMethod</span>();</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Axios</span>.<span class="property"><span class="keyword">prototype</span></span>[method + <span class="string">&#x27;Form&#x27;</span>] = <span class="title function_">generateHTTPMethod</span>(<span class="literal">true</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Axios</span>;</span><br></pre></td></tr></table></figure>
<h4 id="InterceptorManager类"><a href="#InterceptorManager类" class="headerlink" title="InterceptorManager类"></a><center><font color="green">InterceptorManager类</font></center></h4><p>拦截器的管理者，可以添加、删除和清空拦截器。</p>
<p>以下是InterceptorManager类的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(&#123;</span><br><span class="line">    <span class="attr">fulfilled</span>:<span class="function">()=&gt;</span>&#123;&#125;,</span><br><span class="line">    <span class="attr">rejected</span>:<span class="function">()=&gt;</span>&#123;&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>可以看到我们给use传递的是一个对象，对象包含fulfilled函数和rejected函数。</p>
<p>接下来看源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">InterceptorManager</span> &#123;</span><br><span class="line">  <span class="comment">// 构造函数只初始化了一个空的handlers数组</span></span><br><span class="line">  <span class="comment">// 拦截器就是放在这个数组里的</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handlers</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 添加拦截器，返回索引，可以用索引来移除拦截器</span></span><br><span class="line">  <span class="comment">// 可以发现除了fulfilled和rejected，</span></span><br><span class="line">  <span class="comment">// 我们还可以设置synchronous和runWhen</span></span><br><span class="line">  <span class="comment">// runWhen函数用来动态控制是否使用该拦截器</span></span><br><span class="line">  use (fulfilled, rejected, options) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">handlers</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">      fulfilled,</span><br><span class="line">      rejected,</span><br><span class="line">      <span class="attr">synchronous</span>: options ? options.<span class="property">synchronous</span> : <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">runWhen</span>: options ? options.<span class="property">runWhen</span> : <span class="literal">null</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">handlers</span>.<span class="property">length</span> - <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 根据添加时返回的索引去删除拦截器</span></span><br><span class="line">  eject (id) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handlers</span>[id]) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handlers</span>[id] = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 清空拦截器</span></span><br><span class="line">  clear () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handlers</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">handlers</span> = [];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 提供遍历拦截器快捷操作</span></span><br><span class="line">  forEach (fn) &#123;</span><br><span class="line">    utils.<span class="title function_">forEach</span>(<span class="variable language_">this</span>.<span class="property">handlers</span>, <span class="keyword">function</span> <span class="title function_">forEachHandler</span> (h) &#123;</span><br><span class="line">      <span class="keyword">if</span> (h !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">fn</span>(h);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">InterceptorManager</span>;</span><br></pre></td></tr></table></figure>
<h4 id="dispatchRequest发送请求"><a href="#dispatchRequest发送请求" class="headerlink" title="dispatchRequest发送请求"></a><center><font color="green">dispatchRequest发送请求</font></center></h4><p>看完上面的代码，我们已经基本搞清楚了axios的整体流程：</p>
<p>组装config-&gt;组装header-&gt;调用请求拦截器-&gt;发送实际请求-&gt;调用返回拦截器。</p>
<p>但是我们还不知道axios具体是如何调用请求的，那么接下来就要看dispatchRequest代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 暂且先记住，这个函数的作用就是用来判断请求是否被取消，</span></span><br><span class="line"><span class="comment">// 如果要的话，则直接抛出异常，</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throwIfCancellationRequested</span> (config) &#123;</span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">cancelToken</span>) &#123;</span><br><span class="line">    config.<span class="property">cancelToken</span>.<span class="title function_">throwIfRequested</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (config.<span class="property">signal</span> &amp;&amp; config.<span class="property">signal</span>.<span class="property">aborted</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CanceledError</span>(<span class="literal">null</span>, config);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送请求核心函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">dispatchRequest</span> (config) &#123;</span><br><span class="line">  <span class="comment">// 刚开始请求前判断一次是否取消</span></span><br><span class="line">  <span class="title function_">throwIfCancellationRequested</span>(config);</span><br><span class="line"></span><br><span class="line">  config.<span class="property">headers</span> = <span class="title class_">AxiosHeaders</span>.<span class="title function_">from</span>(config.<span class="property">headers</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行数据转换操作</span></span><br><span class="line">  config.<span class="property">data</span> = transformData.<span class="title function_">call</span>(</span><br><span class="line">    config,</span><br><span class="line">    config.<span class="property">transformRequest</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认设置请求头的contentType为application/x-www-form-urlencoded</span></span><br><span class="line">  <span class="keyword">if</span> ([<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;put&#x27;</span>, <span class="string">&#x27;patch&#x27;</span>].<span class="title function_">indexOf</span>(config.<span class="property">method</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">    config.<span class="property">headers</span>.<span class="title function_">setContentType</span>(<span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取适配器，如果是浏览器环境获取xhr，</span></span><br><span class="line">  <span class="comment">// 如果是Node环境，获取http </span></span><br><span class="line">  <span class="comment">// 适配器就是最终用来发送请求的东西</span></span><br><span class="line">  <span class="keyword">const</span> adapter = adapters.<span class="title function_">getAdapter</span>(config.<span class="property">adapter</span> || defaults.<span class="property">adapter</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求是使用适配器执行config</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">adapter</span>(config).<span class="title function_">then</span>(<span class="keyword">function</span> <span class="title function_">onAdapterResolution</span> (response) &#123;</span><br><span class="line">    <span class="comment">// 请求完之后判断是否要取消</span></span><br><span class="line">    <span class="title function_">throwIfCancellationRequested</span>(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对返回结果进行转换</span></span><br><span class="line">    response.<span class="property">data</span> = transformData.<span class="title function_">call</span>(</span><br><span class="line">      config,</span><br><span class="line">      config.<span class="property">transformResponse</span>,</span><br><span class="line">      response</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置返回头</span></span><br><span class="line">    response.<span class="property">headers</span> = <span class="title class_">AxiosHeaders</span>.<span class="title function_">from</span>(response.<span class="property">headers</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;, <span class="keyword">function</span> <span class="title function_">onAdapterRejection</span> (reason) &#123;</span><br><span class="line">    <span class="comment">// 如果不是因为取消而报错</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isCancel</span>(reason)) &#123;</span><br><span class="line">      <span class="comment">// 再次判断是否要取消，如果是会抛出异常</span></span><br><span class="line">      <span class="title function_">throwIfCancellationRequested</span>(config);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 处理正常错误的返回值</span></span><br><span class="line">      <span class="keyword">if</span> (reason &amp;&amp; reason.<span class="property">response</span>) &#123;</span><br><span class="line">        reason.<span class="property">response</span>.<span class="property">data</span> = transformData.<span class="title function_">call</span>(</span><br><span class="line">          config,</span><br><span class="line">          config.<span class="property">transformResponse</span>,</span><br><span class="line">          reason.<span class="property">response</span></span><br><span class="line">        );</span><br><span class="line">        reason.<span class="property">response</span>.<span class="property">headers</span> = <span class="title class_">AxiosHeaders</span>.<span class="title function_">from</span>(reason.<span class="property">response</span>.<span class="property">headers</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(reason);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="adapter-请求适配器，此处以xhr请求适配器为例"><a href="#adapter-请求适配器，此处以xhr请求适配器为例" class="headerlink" title="adapter 请求适配器，此处以xhr请求适配器为例"></a><center><font color="green">adapter 请求适配器，此处以xhr请求适配器为例</font></center></h4><p>dispatchRequest的流程还是相对简单的，剩下的疑惑就是adapter干了些什么，让我们接着往下看吧！</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于给上传和下载进度增加监听函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">progressEventReducer</span> (listener, isDownloadStream) &#123;</span><br><span class="line">  <span class="keyword">let</span> bytesNotified = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">const</span> _speedometer = <span class="title function_">speedometer</span>(<span class="number">50</span>, <span class="number">250</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> loaded = e.<span class="property">loaded</span>;</span><br><span class="line">    <span class="keyword">const</span> total = e.<span class="property">lengthComputable</span> ? e.<span class="property">total</span> : <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">const</span> progressBytes = loaded - bytesNotified;</span><br><span class="line">    <span class="keyword">const</span> rate = <span class="title function_">_speedometer</span>(progressBytes);</span><br><span class="line">    <span class="keyword">const</span> inRange = loaded &lt;= total;</span><br><span class="line"></span><br><span class="line">    bytesNotified = loaded;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">      loaded,</span><br><span class="line">      total,</span><br><span class="line">      <span class="attr">progress</span>: total ? (loaded / total) : <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">bytes</span>: progressBytes,</span><br><span class="line">      <span class="attr">rate</span>: rate ? rate : <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">estimated</span>: rate &amp;&amp; total &amp;&amp; inRange ? (total - loaded) / rate : <span class="literal">undefined</span>,</span><br><span class="line">      <span class="attr">event</span>: e</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    data[isDownloadStream ? <span class="string">&#x27;download&#x27;</span> : <span class="string">&#x27;upload&#x27;</span>] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">listener</span>(data);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否支持XMLHttpRequest</span></span><br><span class="line"><span class="keyword">const</span> isXHRAdapterSupported = <span class="keyword">typeof</span> <span class="title class_">XMLHttpRequest</span> !== <span class="string">&#x27;undefined&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 适配器的请求参数是config</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> isXHRAdapterSupported &amp;&amp; <span class="keyword">function</span> (<span class="params">config</span>) &#123;</span><br><span class="line">  <span class="comment">// 返回Promise</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span> <span class="title function_">dispatchXhrRequest</span> (resolve, reject) &#123;</span><br><span class="line">    <span class="comment">// 请求体</span></span><br><span class="line">    <span class="keyword">let</span> requestData = config.<span class="property">data</span>;</span><br><span class="line">    <span class="comment">// 请求头</span></span><br><span class="line">    <span class="keyword">const</span> requestHeaders = <span class="title class_">AxiosHeaders</span>.<span class="title function_">from</span>(config.<span class="property">headers</span>).<span class="title function_">normalize</span>();</span><br><span class="line">    <span class="comment">// 返回数据类型</span></span><br><span class="line">    <span class="keyword">const</span> responseType = config.<span class="property">responseType</span>;</span><br><span class="line">    <span class="keyword">let</span> onCanceled;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">done</span> () &#123;</span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">cancelToken</span>) &#123;</span><br><span class="line">        config.<span class="property">cancelToken</span>.<span class="title function_">unsubscribe</span>(onCanceled);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">signal</span>) &#123;</span><br><span class="line">        config.<span class="property">signal</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, onCanceled);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 自动帮我们设置contentType,</span></span><br><span class="line">    <span class="comment">// 这就是为什么我们使用的时候都不需要</span></span><br><span class="line">    <span class="comment">// 特别设置contentType的原因了</span></span><br><span class="line">    <span class="keyword">if</span> (utils.<span class="title function_">isFormData</span>(requestData)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (platform.<span class="property">isStandardBrowserEnv</span> || platform.<span class="property">isStandardBrowserWebWorkerEnv</span>) &#123;</span><br><span class="line">        <span class="comment">// 浏览器环境让浏览器设置</span></span><br><span class="line">        requestHeaders.<span class="title function_">setContentType</span>(<span class="literal">false</span>); </span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        requestHeaders.<span class="title function_">setContentType</span>(<span class="string">&#x27;multipart/form-data;&#x27;</span>, <span class="literal">false</span>); </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求</span></span><br><span class="line">    <span class="keyword">let</span> request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置auth，帮我们转码好了</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">auth</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> username = config.<span class="property">auth</span>.<span class="property">username</span> || <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      <span class="keyword">const</span> password = config.<span class="property">auth</span>.<span class="property">password</span> ? <span class="built_in">unescape</span>(<span class="built_in">encodeURIComponent</span>(config.<span class="property">auth</span>.<span class="property">password</span>)) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">      requestHeaders.<span class="title function_">set</span>(<span class="string">&#x27;Authorization&#x27;</span>, <span class="string">&#x27;Basic &#x27;</span> + <span class="title function_">btoa</span>(username + <span class="string">&#x27;:&#x27;</span> + password));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拼接完整URL路径</span></span><br><span class="line">    <span class="keyword">const</span> fullPath = <span class="title function_">buildFullPath</span>(config.<span class="property">baseURL</span>, config.<span class="property">url</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启请求</span></span><br><span class="line">    request.<span class="title function_">open</span>(config.<span class="property">method</span>.<span class="title function_">toUpperCase</span>(), <span class="title function_">buildURL</span>(fullPath, config.<span class="property">params</span>, config.<span class="property">paramsSerializer</span>), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置超时时间</span></span><br><span class="line">    request.<span class="property">timeout</span> = config.<span class="property">timeout</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onloadend</span> () &#123;</span><br><span class="line">      <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 预准备返回体的内容</span></span><br><span class="line">      <span class="keyword">const</span> responseHeaders = <span class="title class_">AxiosHeaders</span>.<span class="title function_">from</span>(</span><br><span class="line">        <span class="string">&#x27;getAllResponseHeaders&#x27;</span> <span class="keyword">in</span> request &amp;&amp; request.<span class="title function_">getAllResponseHeaders</span>()</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">const</span> responseData = !responseType || responseType === <span class="string">&#x27;text&#x27;</span> || responseType === <span class="string">&#x27;json&#x27;</span> ?</span><br><span class="line">        request.<span class="property">responseText</span> : request.<span class="property">response</span>;</span><br><span class="line">      <span class="keyword">const</span> response = &#123;</span><br><span class="line">        <span class="attr">data</span>: responseData,</span><br><span class="line">        <span class="attr">status</span>: request.<span class="property">status</span>,</span><br><span class="line">        <span class="attr">statusText</span>: request.<span class="property">statusText</span>,</span><br><span class="line">        <span class="attr">headers</span>: responseHeaders,</span><br><span class="line">        config,</span><br><span class="line">        request</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 请求完之后判断请求是成功还是失败</span></span><br><span class="line">      <span class="comment">// 执行resolve和reject的操作</span></span><br><span class="line">      <span class="title function_">settle</span>(<span class="keyword">function</span> <span class="title function_">_resolve</span> (value) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(value);</span><br><span class="line">        <span class="title function_">done</span>();</span><br><span class="line">      &#125;, <span class="keyword">function</span> <span class="title function_">_reject</span> (err) &#123;</span><br><span class="line">        <span class="title function_">reject</span>(err);</span><br><span class="line">        <span class="title function_">done</span>();</span><br><span class="line">      &#125;, response);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 清除request</span></span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;onloadend&#x27;</span> <span class="keyword">in</span> request) &#123;</span><br><span class="line">      <span class="comment">// 设置onloadend</span></span><br><span class="line">      request.<span class="property">onloadend</span> = onloadend;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Listen for ready state to emulate onloadend</span></span><br><span class="line">      request.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> <span class="title function_">handleLoad</span> () &#123;</span><br><span class="line">        <span class="keyword">if</span> (!request || request.<span class="property">readyState</span> !== <span class="number">4</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The request errored out and we didn&#x27;t get a response, this will be</span></span><br><span class="line">        <span class="comment">// handled by onerror instead</span></span><br><span class="line">        <span class="comment">// With one exception: request that using file: protocol, most browsers</span></span><br><span class="line">        <span class="comment">// will return status as 0 even though it&#x27;s a successful request</span></span><br><span class="line">        <span class="keyword">if</span> (request.<span class="property">status</span> === <span class="number">0</span> &amp;&amp; !(request.<span class="property">responseURL</span> &amp;&amp; request.<span class="property">responseURL</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27;file:&#x27;</span>) === <span class="number">0</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// readystate handler is calling before onerror or ontimeout handlers,</span></span><br><span class="line">        <span class="comment">// so we should call onloadend on the next &#x27;tick&#x27;</span></span><br><span class="line">        <span class="comment">// readystate之后再执行onloadend</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(onloadend);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理浏览器请求取消事件</span></span><br><span class="line">    request.<span class="property">onabort</span> = <span class="keyword">function</span> <span class="title function_">handleAbort</span> () &#123;</span><br><span class="line">      <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(<span class="string">&#x27;Request aborted&#x27;</span>, <span class="title class_">AxiosError</span>.<span class="property">ECONNABORTED</span>, config, request));</span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理低级的网络错误</span></span><br><span class="line">    request.<span class="property">onerror</span> = <span class="keyword">function</span> <span class="title function_">handleError</span> () &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(<span class="string">&#x27;Network Error&#x27;</span>, <span class="title class_">AxiosError</span>.<span class="property">ERR_NETWORK</span>, config, request));</span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理超时</span></span><br><span class="line">    request.<span class="property">ontimeout</span> = <span class="keyword">function</span> <span class="title function_">handleTimeout</span> () &#123;</span><br><span class="line">      <span class="keyword">let</span> timeoutErrorMessage = config.<span class="property">timeout</span> ? <span class="string">&#x27;timeout of &#x27;</span> + config.<span class="property">timeout</span> + <span class="string">&#x27;ms exceeded&#x27;</span> : <span class="string">&#x27;timeout exceeded&#x27;</span>;</span><br><span class="line">      <span class="keyword">const</span> transitional = config.<span class="property">transitional</span> || transitionalDefaults;</span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">timeoutErrorMessage</span>) &#123;</span><br><span class="line">        timeoutErrorMessage = config.<span class="property">timeoutErrorMessage</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(</span><br><span class="line">        timeoutErrorMessage,</span><br><span class="line">        transitional.<span class="property">clarifyTimeoutError</span> ? <span class="title class_">AxiosError</span>.<span class="property">ETIMEDOUT</span> : <span class="title class_">AxiosError</span>.<span class="property">ECONNABORTED</span>,</span><br><span class="line">        config,</span><br><span class="line">        request));</span><br><span class="line"></span><br><span class="line">      request = <span class="literal">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加 xsrf</span></span><br><span class="line">    <span class="keyword">if</span> (platform.<span class="property">isStandardBrowserEnv</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> xsrfValue = (config.<span class="property">withCredentials</span> || <span class="title function_">isURLSameOrigin</span>(fullPath))</span><br><span class="line">        &amp;&amp; config.<span class="property">xsrfCookieName</span> &amp;&amp; cookies.<span class="title function_">read</span>(config.<span class="property">xsrfCookieName</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (xsrfValue) &#123;</span><br><span class="line">        requestHeaders.<span class="title function_">set</span>(config.<span class="property">xsrfHeaderName</span>, xsrfValue);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无请求体的话就移除contentType</span></span><br><span class="line">    requestData === <span class="literal">undefined</span> &amp;&amp; requestHeaders.<span class="title function_">setContentType</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加headers </span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;setRequestHeader&#x27;</span> <span class="keyword">in</span> request) &#123;</span><br><span class="line">      utils.<span class="title function_">forEach</span>(requestHeaders.<span class="title function_">toJSON</span>(), <span class="keyword">function</span> <span class="title function_">setRequestHeader</span> (val, key) &#123;</span><br><span class="line">        request.<span class="title function_">setRequestHeader</span>(key, val);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加withCredentials </span></span><br><span class="line">    <span class="keyword">if</span> (!utils.<span class="title function_">isUndefined</span>(config.<span class="property">withCredentials</span>)) &#123;</span><br><span class="line">      request.<span class="property">withCredentials</span> = !!config.<span class="property">withCredentials</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 添加responseType</span></span><br><span class="line">    <span class="keyword">if</span> (responseType &amp;&amp; responseType !== <span class="string">&#x27;json&#x27;</span>) &#123;</span><br><span class="line">      request.<span class="property">responseType</span> = config.<span class="property">responseType</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加下载过程的监听函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> config.<span class="property">onDownloadProgress</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      request.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, <span class="title function_">progressEventReducer</span>(config.<span class="property">onDownloadProgress</span>, <span class="literal">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加上传过程的监听函数</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> config.<span class="property">onUploadProgress</span> === <span class="string">&#x27;function&#x27;</span> &amp;&amp; request.<span class="property">upload</span>) &#123;</span><br><span class="line">      request.<span class="property">upload</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;progress&#x27;</span>, <span class="title function_">progressEventReducer</span>(config.<span class="property">onUploadProgress</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求过程中取消</span></span><br><span class="line">    <span class="keyword">if</span> (config.<span class="property">cancelToken</span> || config.<span class="property">signal</span>) &#123;</span><br><span class="line">      </span><br><span class="line">      onCanceled = <span class="function"><span class="params">cancel</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!request) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">reject</span>(!cancel || cancel.<span class="property">type</span> ? <span class="keyword">new</span> <span class="title class_">CanceledError</span>(<span class="literal">null</span>, config, request) : cancel);</span><br><span class="line">        request.<span class="title function_">abort</span>();</span><br><span class="line">        request = <span class="literal">null</span>;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      config.<span class="property">cancelToken</span> &amp;&amp; config.<span class="property">cancelToken</span>.<span class="title function_">subscribe</span>(onCanceled);</span><br><span class="line">      <span class="keyword">if</span> (config.<span class="property">signal</span>) &#123;</span><br><span class="line">        config.<span class="property">signal</span>.<span class="property">aborted</span> ? <span class="title function_">onCanceled</span>() : config.<span class="property">signal</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;abort&#x27;</span>, onCanceled);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取请求协议，比如https这样的</span></span><br><span class="line">    <span class="keyword">const</span> protocol = <span class="title function_">parseProtocol</span>(fullPath);</span><br><span class="line">    <span class="comment">// 判断当前环境是否支持该协议</span></span><br><span class="line">    <span class="keyword">if</span> (protocol &amp;&amp; platform.<span class="property">protocols</span>.<span class="title function_">indexOf</span>(protocol) === -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">AxiosError</span>(<span class="string">&#x27;Unsupported protocol &#x27;</span> + protocol + <span class="string">&#x27;:&#x27;</span>, <span class="title class_">AxiosError</span>.<span class="property">ERR_BAD_REQUEST</span>, config));</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送请求</span></span><br><span class="line">    request.<span class="title function_">send</span>(requestData || <span class="literal">null</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

            </div>

            <!-- Post information -->
            
            
    <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1">
        <ul class="pagination d-block text-center">
            
            
                <li class="next page-item d-inline"><a href="/2024/01/21/width100/" class="page-link float-right">Older  &rarr;</a></li>
            
        </ul>
    </div>


            
                <!-- Comments -->
                

                

            

        </div>
    </div>
</article> 


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    <style>
        #toc-content .toc-link::before {
            background-color: transparent;
            max-height: 25px;
        }

        #toc-content .toc-link.is-active-link::before {
            background-color: #404040;
        }
    </style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <div class="ui-toc dropup scrollspy-body pull-right" style="right: 3%;">
        <button type="button" class="toc-btn btn btn-light" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
            <i class="fas fa-list"></i>
        </button>
        <div class="dropdown-menu dropdown-menu-right p-2"  aria-labelledby="tocLabel">
            <div class="toc-widget">
                <div id="toc-content" class="text-truncate">
                </div>
            </div>
            <div class="toc-menu pt-3 pl-4">
                <a class="expand-toggle d-block py-1" href="#"><span class="expand-text">Expand all</span><span class="close-text" style="display: none;">Collapse all</span></a>
                <a class="back-to-top d-block py-1" href="#">Back to top</a>
                <a class="go-to-bottom d-block py-1" href="#">Go to bottom</a>
            </div>
        </div>
    </div>
    <script>
        tocbot.init({
            // Where to render the table of contents.
            tocSelector: '#toc-content',
            // Where to grab the headings to build the table of contents.
            contentSelector: 'article',
            // Which headings to grab inside of the contentSelector element.
            headingSelector: 'h1, h2, h3',
            // For headings inside relative or absolute positioned containers within content.
            hasInnerContainers: true,
        });
    </script>


    


    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer id="footer">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 offset-lg-2 col-md-10 offset-md-1 text-center">
                <ul class="list-inline">
                    

                    

                    

                    

                    

                    
                </ul>
                <ul class="copyright footer-menu list-inline">
                    
                    
                        <li class="list-inline-item">
                            
                            
                            <a href="/">
                                
                                    首页
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/archives">
                                
                                    归档
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/tags">
                                
                                    标签
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/categories">
                                
                                    类别
                                
                            </a>
                        </li>
                    
                        <li class="list-inline-item">
                            
                                <span class="copyright-split">&nbsp;|&nbsp;</span>
                            
                            
                            <a href="/about">
                                
                                    关于
                                
                            </a>
                        </li>
                    
                </ul>
                <p class="copyright footer-author">
                    &copy; -2024 
                    <a rel="external" class="copyright-link" href="" target="_blank">John Doe</a><br/>
                    Powered by <a rel="external" class="copyright-link" href="https://hexo.io/" target="_blank">Hexo</a>  
                    <span class="copyright-split">&nbsp;|&nbsp;&nbsp;</span>
                    Theme <a rel="external" class="copyright-link" href="https://github.com/luswdev/hexo-theme-clean.git" target="_blank">Clean</a>
                    
                    
                </p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    <!-- jQuery -->
<script src="//cdn.jsdelivr.net/npm/jquery@2.1.4/dist/jquery.min.js"></script>

<!-- For drop down -->
<script src="//cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>

<!-- Bootstrap -->
<script src="//cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>
<!-- Gallery -->
<script src="//cdn.jsdelivr.net/npm/lightgallery@1.6.11/dist/js/lightgallery-all.min.js"></script>
<!-- Busuanzi -->


<!-- Search script -->

<script src="/js/search.js"></script>

<script type="text/javascript">
    $(function () {
        searchFunc( '/search.xml' , 'searchInput', 'searchResult');
    });
</script>



<script src="/js/main.js"></script>



    <!-- Search Modal -->
    <!-- Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
        <div class="modal-content overflow-auto">
            <div class="modal-header">
                <input type="text" class="form-control" placeholder="Searching Keywords..." id="searchInput">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="searchResult">
                    <div class="search-empty text-center text-muted p-5">
                        <i class="far fa-meh"></i>
                    </div>
                </div>
            </div> 
        </div>
    </div>
</div>


</body>
</html>